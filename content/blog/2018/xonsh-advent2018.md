---
title: "Xonshã§ãƒ¢ãƒ€ãƒ³ãªã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’1åˆ†ã§æ§‹ç¯‰ã™ã‚‹"
date: 2018-11-25T01:54:01+09:00
draft: false
categories: 
- Xonsh
tags: 
- Xonsh
- Shell
- Python
- Advent Calendar
keywords:
- ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
- ã‚³ãƒ³ã‚·ãƒ¥
- ã‚·ã‚§ãƒ«
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
- ãƒ¢ãƒ€ãƒ³
---



ã“ã®è¨˜äº‹ã¯[Xonsh Advent Calendar 2018](https://qiita.com/advent-calendar/2018/xonsh) 24æ—¥åˆ†ã®è¨˜äº‹ã§ã™ï¼ï¼ˆ27æ—¥ã«å®Œæˆç‰ˆæ›¸ã„ã¦ã„ã¾ã™ï¼å¤§é…åˆ»ã™ã¿ã¾ã›ã‚“ï¼ï¼‰

è¨˜äº‹ã®æ§‹æˆã¯ï¼šxonshã®ç´¹ä»‹ï¼Œä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½œã‚‹æµã‚Œï¼Œã‚³ãƒ¼ãƒ‰ã®ã¾ã¨ã‚ã¨ã„ã†é¢¨ã«ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ï¼

ã‚¿ã‚¤ãƒˆãƒ«ã®é€šã‚Šã€Œ1åˆ†ã§æ§‹ç¯‰ã€ã—ãŸã„æ–¹ã¯ï¼Œã¾ã¨ã‚ã«é£›ã‚“ã§xonshrcã‚’ã‚³ãƒ”ãƒšã™ã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ï¼



# xonshæ¦‚è¦³

xonshã¯Pythonè£½ã®ã‚·ã‚§ãƒ«ã§ã™ï¼
ç™ºéŸ³ã¯ã‚³ãƒ³ã‚·ãƒ¥ã¨å…¬å¼ã«ã‚ã‚Šã¾ã—ãŸï¼xontribã¯ã‚³ãƒ³ãƒˆãƒªãƒ–ï¼Œxonfigã¯ã‚³ãƒ³ãƒ•ã‚£ã‚°ã¨ãªã‚Šã—ã£ãã‚Šãã¾ã™ã­ï¼

xonshã‚’çŸ¥ã£ã¦ã‹ã‚‰SSHã—ã¦ä½œæ¥­ã™ã‚‹ã¨ãã¯xonshã‚’å…¥ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ï¼ä»Šå¾Œã‚‚åŒã˜ã‚ˆã†ã«ã—ã¦ã„ãæ°—ãŒã™ã‚‹ã®ã§ï¼Œç§ã®é€šã£ãŸé“ï¼ˆSSHã—ãŸå…ˆï¼‰ã«ã¯xonshãŒæ®‹ã•ã‚Œã¦ã„ã‚‹...ã¨ã‹è¨€ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã‚“ã˜ã‚ƒãªã„ã§ã—ã‚‡ã†ã‹ï¼ğŸ˜

xonshã®ã„ã„ã¨ã“ã‚ï¼Œã‚ã‹ã‚Šã«ãã„ã¨ã“ã‚ãŒä½•ã‹ï¼ŒæŒ¯ã‚Šè¿”ã£ã¦ã¿ã¾ã—ãŸï¼

## Prosï¼ˆã„ã„ã¨ã“ã‚ï¼‰

- Pythonã§ã‚·ã‚§ãƒ«ãŒæ›¸ã‘ã‚‹

- ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒç°¡å˜

- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒªãƒƒãƒãªæ©Ÿèƒ½



ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯äººé¡ã«ã¯æ—©ã™ãã‚‹ã¨æ„Ÿã˜ã‚‹ã“ã¨ãŒã‚ã‚‹ä¸­ï¼ŒPythonistaã«ã¨ã£ã¦Pythonæ–‡æ³•ã§ã‚·ã‚§ãƒ«ãŒæ›¸ã‘ã‚‹ã¨ã„ã†ç‚¹ã ã‘ã§ã‚‚ï¼Œä½¿ã‚ãªã„æ‰‹ã¯ãªã„ã¨æ€ã„ã¾ã™ï¼

`pip install xonsh`ã§å…¥ã‚Šã¾ã™ã—ï¼Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è£œå®Œã‚µã‚¸ã‚§ã‚¹ãƒˆãŒã§ããŸã‚Šã—ã¦ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼



### ä½¿ç”¨ä¾‹

ãƒãƒ¼ã‚¸æ¸ˆã¿ã®ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤ã™ã‚‹å‡¦ç†

```
$ for s in [i.lstrip() for i in $(git branch --merged).split('\n')]:
.     if (s != '') and (s[0] != '*') and (s != 'master'):
.         $(git branch -d @(s))
.
```

ã‚·ã‚§ãƒ«èŠ¸ã¯å¾—æ„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒï¼ŒPythonãªã®ã§ã“ã‚“ãªå‡¦ç†ãŒã‚µãƒ©ãƒƒã¨æ›¸ã‘ã¦ã—ã¾ã„ã¾ã™ï¼

ï¼ˆã‚‚ã£ã¨ã„ã„ã‚„ã‚Šæ–¹ãŒã‚ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆã§æ•™ãˆã¦ãã ã•ã„ï¼‰



## Consï¼ˆã‚ã‹ã‚Šã«ãã„ã¨ã“ã‚ï¼‰

- historyãŒæ€ã£ã¦ã‚‹å‹•ãã‚’ã—ãªãã¦æœ€åˆã‚ã‹ã‚‰ãªã„

xonshã®historyã¯å¤šæ•°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼Ÿã‚’ã¤ãªãã“ã¨ã‚’æœ€åˆã‹ã‚‰æƒ³å®šã—ã¦ãŠã‚Šï¼Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§historyã‚’å©ã„ã¦ã‚‚æ¥ç¶šä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å±¥æ­´ã—ã‹è¡¨ç¤ºã•ã‚Œãªã„ï¼

ã“ã‚Œã¯ï¼Œ`history`ã¯`history show`ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã ã‹ã‚‰ã§ã™ï¼

```
$ history show all
```

ã™ã‚‹ã¨ä»Šã¾ã§ã®å…¨å±¥æ­´ã‚’è¡¨ç¤ºã—ã¦ãã‚Œã¾ã™ï¼

Cf: document https://xon.sh/tutorial_hist.html



## ç·ã˜ã¦

ä½¿ã‚ãªã„æ‰‹ã¯ãªã„ã‚“ã˜ã‚ƒãªã„ã§ã—ã‚‡ã†ã‹ï¼

ç§ã®é‹ç”¨æ–¹æ³•ã¨ã—ã¦ã¯ï¼Œã‚µãƒ¼ãƒä¸Šã§ã¯bashä¸Šã§xonshã‚’èµ·å‹•ã—ã¦ä½œæ¥­ã—ã¦ã„ã¾ã™ï¼

æ‰‹å…ƒã§ã¯fishã‚’ä½¿ã£ã¦ã„ã¦ï¼Œå¿…è¦ãªæ™‚ã«xonshã‚’ç«‹ã¡ä¸Šã’ã¦ä½œæ¥­ã—ã¾ã™ï¼



# ãƒ¢ãƒ€ãƒ³ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å®Ÿç¾ã™ã‚‹

ç…½ã‚Œã‚‹ã‚¿ã‚¤ãƒˆãƒ«ãªã«ã‹ãªã€œã¨è€ƒãˆã¦ã²ã­ã‚Šå‡ºã—ãŸãƒ¢ãƒ€ãƒ³ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã„ã†ãƒ•ãƒ¬ãƒ¼ã‚ºã§ã™ãŒï¼Œè¦‹ã‚„ã™ãã¦ã‹ã£ã“ã„ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã“ã¨ã§ã™ï¼

ä»Šæ™‚ã¯powerlineãŒã‚ã‚Šï¼Œxonsh-powerlineã‚‚ã‚ã‚‹ã®ã§ä¸€ç™ºã§å…¥ã‚‹ã®ã§ã™ãŒï¼Œè¦‹ãŸç›®ã®ç´°ã‹ã„å¥½ã¿ãŒã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ï¼

xonshã¯æ‰‹è»½ã«é«˜åº¦ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒã§ãã¾ã™ï¼ãã®æ–¹æ³•ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ï¼

## xonshã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šæ–¹æ³•

`$PROMPT`ã§æ–‡å­—åˆ—ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼

```terminal
>>> $PROMPT = '{user}@{hostname}:{cwd} > '
qqhann@home:~ > #ç°¡å˜ã«å¤‰æ›´ã§ãã¾ã—ãŸï¼
qqhann@home:~ > $PROMPT = "[ {short_cwd} ]\n$ "
[ ~/.c/xonsh ]
$ pwd
/Users/qqhann/.config/xonsh
```

ã“ã®ã‚ˆã†ã«ï¼Œç°¡å˜ã«å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼

ç‰¹ã«`short_cwd`ãŒãŠã™ã™ã‚ã§ã™ï¼æ‰‹å‰å‘³å™Œã§ã™ãŒã“ã‚Œã®`.`ã§å§‹ã¾ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’2æ–‡å­—ã§è¡¨ç¤ºã™ã‚‹ãƒ‘ãƒƒãƒã‚’æŠ•ã’ã¦ï¼Œcontributorã«ãªã‚Šã¾ã—ãŸï¼OSSã¯æ¥½ã—ã„ï¼

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆhttps://xon.sh/tutorial.html#customizing-the-prompt



## ã•ã‚‰ã«è‡ªç”±åº¦ã®é«˜ã„è¨­å®š

ã•ã‚‰ã«è‡ªç”±åº¦ã®é«˜ã„è¨­å®šã‚’ã—ãŸã„å ´åˆã¯ï¼Œãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç™»éŒ²ã—ã¦`$PROMPT`ã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ï¼

`$PROMPT_FIELDS['your_field'] = lambda: 'foobar'`ã§`$PROMPT`ã«è¡¨ç¤ºå¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®šã§ãã¾ã™ï¼



å…¬å¼ã®promptã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰https://github.com/xonsh/xonsh/tree/master/xonsh/prompt



## ç›®æŒ‡ã™ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

æ™®æ®µç§ãŒä½¿ç”¨ã—ã¦ã„ã‚‹fishã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ã“ã¡ã‚‰ï¼š[dollar-fish](https://github.com/qqhann/dollar-fish) ï¼ˆ[bobthefish](https://github.com/oh-my-fish/theme-bobthefish)ã‹ã‚‰ã‚¢ãƒ¬ãƒ³ã‚¸ã—ãŸã‚‚ã®ã§ã™ï¼‰

gitãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸­ã«ã„ã‚‹æ™‚ï¼Œbase directoryã¾ã§ã®ãƒ‘ã‚¹ã‚’çŸ­ç¸®è¡¨ç¤ºã—ã¦ï¼Œgit directoryå†…ã®ãƒ‘ã‚¹ã‚’ãƒ•ãƒ«ã§è¡¨ç¤ºã™ã‚‹æ–¹å¼ã§ã™ï¼

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¡¨ç¤ºæ–¹æ³•ãŒæ°—ã«å…¥ã£ã¦ã„ã‚‹ã®ã§ï¼Œxonshã§ã“ã‚Œã‚’å®Ÿç¾ã—ãŸã„ã¨æ€ã„ã¾ã™ï¼



### ã©ã†å®Ÿç¾ã™ã‚‹ã‹

#### dollar-fishã®æ–¹æ³•ï¼šgitã®toplevelã¨prefix

ã‚½ãƒ¼ã‚¹ã‚’æ”¹ã‚ã¦è¦‹ã¦ã¿ã‚‹ã¨gitã‚³ãƒãƒ³ãƒ‰ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã—ãŸï¼

```fish
set -l project_pwd (command git rev-parse --show-prefix ^/dev/null | string trim --right --chars=/)
set -l work_dir (command git rev-parse --show-toplevel ^/dev/null)
```



#### ãã‚Œã‚’ã©ã†æ›¸ãã‹

èª¿ã¹ãŸã‘ã©ä½¿ã‚ãªã‹ã£ãŸé›‘ã‚ã‚‚ï¼

xonshã¯Pythonã§å‡¦ç†éƒ¨åˆ†ã‚’æ›¸ã„ã¦ã‚‹ã£ã½ã„ï¼

`builtins.__xonsh__.env["PWD"]`ã¨ã‹ã®å‡¦ç†ã¾ã§ã¯ç¾æ™‚ç‚¹ã§è¾¿ã£ã¦ã¿ã¦ã„ãªã„ãŒï¼Œ`_collapsed_pwd`ãªã‚“ã‹ã¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¡¨ç¤ºã®å‡¦ç†ã‚’Pythonã§æ›¸ã„ã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚‹ï¼

https://github.com/xonsh/xonsh/blob/master/xonsh/prompt/cwd.py

`builtins`ã«`builtins.__xonsh__`ãŒå«ã¾ã‚Œã¦ã„ã‚‹ä»•çµ„ã¿ãŒã‚ˆãã‚ã‹ã£ã¦ãªã„ã®ã§æ•™ãˆã¦å¼·ã„äººï¼



#### `$()`è¨˜æ³•ã‚’ä½¿ã†

ä»Šå›ã¯ã“ã‚Œä»¥ä¸Šæ·±æ˜ã‚Šã›ãšï¼Œxonshã®`$()`è¨˜æ³•ã‚’ç´ ç›´ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸï¼

xonshã‹ã‚‰gitã‚³ãƒãƒ³ãƒ‰ã‚’å‘¼ã³å‡ºã›ã°è‰¯ã•ãã†ã§ã™ï¼



### ã•ã‚‰ã«ï¼Œç›´å‰ã®ã‚³ãƒãƒ³ãƒ‰ã®æˆå¦ã«ã‚ˆã‚Šè‰²ã‚’å¤‰ãˆã‚‹

ä¸€ã¤å‰ã®ã‚³ãƒãƒ³ãƒ‰ã®çµæœã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹æ–¹æ³•

https://github.com/xonsh/xonsh/issues/1146

`__xonsh_history__.rtns[-1]`ã¨ã®å›ç­”ã ãŒ `__xonsh_history__.warn()`ã«ã‚ˆã‚Œã° `__xonsh__.history`ã«å¤‰æ›´ã«ãªã£ã¦ã„ã‚‹ï¼ã“ã‚Œã‚’ä½¿ãˆã°è‰¯ã•ãã†ã§ã™ï¼



è‰²ã‚’å¤‰ãˆã‚‹æ–¹æ³•ã§åµŒã£ã¦ã—ã¾ã„ã¾ã—ãŸãŒï¼Œè‰²ã‚’å‹•çš„ã«å¤‰ãˆã‚‹å ´åˆï¼Œ

`return 'GREEN'`ã§ã¯ãªã`return '{GREEN}'`ã®ã‚ˆã†ã«ã™ã‚‹ã¨ã†ã¾ãã„ãã¾ã™ï¼



# ã¾ã¨ã‚

å®Œæˆå½¢

```python
def _git_prefix():
    import xonsh.tools as xt

    prefix = $(git rev-parse --show-prefix).strip()
    sep = xt.get_sep()

    if len(prefix) == 0:
        return prefix
    else:
        return sep + prefix if prefix[0] != sep else prefix

$PROMPT_FIELDS['git_prefix'] = _git_prefix


def _git_toplevel_or_cwd():
    import xonsh.tools as xt
    from xonsh.prompt.cwd import _replace_home

    toplevel = $(git rev-parse --show-toplevel).strip()
    pwd = toplevel if toplevel else $PWD

    sep = xt.get_sep()
    pwd = _replace_home(pwd).split(sep)
    l = len(pwd)
    leader = sep if l > 0 and len(pwd[0]) == 0 else ""
    base = [i[0]
            if ix != l - 1 and i[0] != '.' else i[0:2]
            if ix != l - 1 else i for ix, i in enumerate(pwd) if len(i) > 0]
    return leader + sep.join(base)

$PROMPT_FIELDS['git_toplevel'] = _git_toplevel_or_cwd


def _success_color():
    if __xonsh__.history.rtns and __xonsh__.history.rtns[-1] != 0:
        return '{#cc6666}'  # red
    else:
        return '{#f0c674}'

$PROMPT_FIELDS['success_color'] = _success_color

$PROMPT = "{INTENSE_BLACK}[ {INTENSE_WHITE}{git_toplevel}{INTENSE_BLACK}{git_prefix} ]\n{success_color}${WHITE} "


```

ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’xonshrcã«ã‚³ãƒ”ãƒ¼ã—ã¦å¿«é©ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å§‹ã‚ã¾ã—ã‚‡ã†â™ª

![xonsh-prompt](/images/xonsh-advent2018.png)

---

åˆã‚ã¦ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãªã‚‹ã‚‚ã®ã‚’æ›¸ãã¾ã—ãŸï¼ã„ã‹ãŒã ã£ãŸã§ã—ã‚‡ã†ã‹ï¼ã©ã†ãæ°—è»½ã«ã‚³ãƒ¡ãƒ³ãƒˆãã ã•ã„ï¼

[Twitterã‚‚ã‚„ã£ã¦ã„ã‚‹](https://twitter.com/qqhann)ã®ã§ãƒ•ã‚©ãƒ­ãƒ¼é ‚ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ï¼

ãã‚Œã§ã¯ï¼Œã‚¯ãƒªã‚¹ãƒã‚¹éãã¡ã‚ƒã£ãŸã‘ã©ï¼Œã¿ãªã•ã‚“è‰¯ã„ãŠå¹´ã‚’ï¼

